(window.webpackJsonp=window.webpackJsonp||[]).push([[98],{578:function(s,t,a){"use strict";a.r(t);var e=a(32),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"mysql使用mycat读写分离报错"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql使用mycat读写分离报错"}},[s._v("#")]),s._v(" mysql使用mycat读写分离报错")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v(" Connection is read-only. Queries leading to data modification are not allow\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"解决方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方法"}},[s._v("#")]),s._v(" 解决方法")]),s._v(" "),a("p",[s._v("在jdbc的url上加useLocalSessionState=true")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("spring.datasource.url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("jdbc:mysql://192.168.0.1:8080/summer?useUnicode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("characterEncoding")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("allowMultiQueries")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("useLocalSessionState")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"uselocalsessionstate解释及影响"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uselocalsessionstate解释及影响"}},[s._v("#")]),s._v(" useLocalSessionState解释及影响")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("描述")]),s._v(" "),a("p",[s._v("useLocalSessionState:驱动程序是否应引用autocommit的内部值，以及由Connection.setAutoCommit()和Connection.setTransactionIsolation()设置的事务隔离，而不是查询数据库.")])]),s._v(" "),a("li",[a("p",[s._v("作用")]),s._v(" "),a("p",[a("strong",[s._v("默认情况下")]),s._v("，我们的连接串信息没有包含useLocalSessionState参数的设置，这个值默认为false。这个值的作用是驱动程序是否使用autocommit，read_only和transaction isolation的内部值(jdbc端的本地值)。如果设置为false，则需要这个判断三个参数的场景，都需要发语句到远端请求，比如更新语句前，需要发语句select @@session.tx_read_only确认会话是否只读。如果设置为true，则只需要取本地值即可。这可以解释为什么有的实例 select @@session.tx_read_only语句很多。一般情况下，驱动可以保证本地值与远程服务器值保持一致。当应用调用setAutoCommit, setTransactionIsolation 和 setReadOnly这三个接口设置参数值时，会与远程服务器同步。")]),s._v(" "),a("p",[a("strong",[s._v("具体而言")]),s._v("，当useLocalSessionState为true时，若值与本地值不一致，则发往远程更新。当useLocalSessionState为false时，无论设置值与本地值是否一致，每次都发往远程更新。这可以解释为什么有些实例set autocommit语句比较多。")])]),s._v(" "),a("li",[a("p",[s._v("影响")]),s._v(" "),a("p",[s._v("但是，若用户设置参数时不通过JDBC接口(比如setAutoCommit)，而是执行语句'set autocommit=xxx'设置，那么就会存在本地值与远程不一致的情况，进而可能导致修改参数useLocalSessionState后，业务逻辑发生变化。")])])]),s._v(" "),a("ul",[a("li",[s._v("相关设置的SQL语句：")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v("  autocommit"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*设置会话自动提交模式*/")]),s._v("   对应的JDBC接口：setAutoCommit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" tx_isolation"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'read-committed'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*设置事务的隔离级别*/")]),s._v("  对应的JDBC接口：setTransactionIsolation"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'read-committed'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" tx_read_only"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*设置只读事务*/")]),s._v("  对应的JDBC接口：setReadOnly"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("设置useLocalSessionState默认值为ture，可能导致业务逻辑含义发生变化。触发的条件是，用户通过SQL语句直接设置自动提交参数，隔离级别参数或只读事务参数。")])])])}),[],!1,null,null,null);t.default=n.exports}}]);